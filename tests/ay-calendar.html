<template id="ay-calendar-template">
    <div class="calendar" data-attach="calNode">
        <div class="cal-header" data-attach="headerNode">
            <span class="cal-lft" data-attach="lftNode"></span>
            <span class="cal-month" data-attach="monthNode"></span>
            <span class="cal-rgt" data-attach="rgtNode"></span>
        </div>
        <div class="cal-container" data-attach="container"></div>
        <div class="cal-footer">
            <a href="javascript:void(0);" data-attach="footerLink"></a>
        </div>
    </div>
</template>

<script>
    (function () {
        'use strict';

        alloy.createComponent({
            tag:        'ay-calendar',
            templateId: 'ay-calendar-template',

            properties: [
                'range-picker',
                'range-left',
                'range-right'
            ],

            created: function(){
                this.previous = {};
                this.modes = ['month', 'year', 'decade'];
                this.mode = 0;
            },

            domReady: function () {
                if (this.hasAttribute('range-left')) {
                    this.rgtNode.style.display = 'none';
                    this['range-picker'] = true;
                    this.isOwned = true;
                }
                if (this.hasAttribute('range-right')) {
                    this.lftNode.style.display = 'none';
                    this['range-picker'] = true;
                    this.isOwned = true;
                }
                if(this.isOwned){
                    this.classList.add('minimal');
                }

                this.current = copy(this.value);

                this.connect();
                this.render();

                this.domReady = function () {};
            },

            value: {
                get: function () {
                    return this.getValue();
                },
                set: function (value) {
                    this.setValue(value);
                    this.lastValidValue = value;
                }
            },

            attributeChanged: function (prop, value) {
                if(prop === 'value'){
                    this.setValue(value);
                }
            },

            setValue: function (value) {
                this.valueDate = alloy.dates.isDateType(value) ? alloy.dates.strToDate(value) : today;
                this.current = this.valueDate;
                this.render();
            },

            getValue: function () {
                if(!this.valueDate) {
                    var value = this.getAttribute('value') || today;
                    this.valueDate = alloy.dates.strToDate(value);
                }
                return this.valueDate;
            },

            setDisplay: function (/*year, month*/) {
                var args = arguments;
                if(args.length === 2) {
                    this.current.setFullYear(args[0]);
                    this.current.setMonth(args[1]);
                }else if(typeof args[0] === 'object'){
                    this.current.setFullYear(args[0].getFullYear());
                    this.current.setMonth(args[0].getMonth());
                }else if(args[0] > 12){
                    this.current.setFullYear(args[0]);
                }else{
                    this.current.setMonth(args[0]);
                }
                this.noEvents = true;
                this.render();
            },

            getFormattedValue: function () {
                return this.valueDate === today ? '' : !!this.valueDate ? alloy.dates.dateToStr(this.valueDate) : '';
            },

            emitValue: function () {
                // TODO options for timestamp or other formats
                var event = {
                    value: this.getFormattedValue(),
                    date: this.valueDate
                };
                if(this['range-picker']){
                    event.first = this.firstRange;
                    event.second = this.secondRange;
                }
                this.emit('change', event);
            },

            emitDisplayEvents: function () {
                var month = this.current.getMonth(),
                    year = this.current.getFullYear();

                if(!this.noEvents && (month !== this.previous.month || year !== this.previous.year)){
                    this.fire('display-change', {month: month,year:year});
                }

                this.noEvents = false;
                this.previous = {
                    month: month,
                    year: year
                };
            },

            connect: function () {
                this.on(this.lftNode, 'click', function () {
                    this.onClickMonth(-1);
                }.bind(this));

                this.on(this.rgtNode, 'click', function () {
                    this.onClickMonth(1);
                }.bind(this));

                this.on(this.footerLink, 'click', function () {
                    this.current = new Date();
                    this.render();
                }.bind(this));

                this.on(this.container, 'click', function (e) {
                    this.fire('pre-click', e, true, true);
                    var node = e.target;
                    if(node.classList.contains('day')){
                        this.onClickDay(node);
                    }
                    else if(node.classList.contains('year')){
                        this.onClickYear(node);
                    }
                    else if(node.classList.contains('decade')){
                        this.onClickDecade(node);
                    }
                }.bind(this));

                this.on(this.monthNode, 'click', function(){
                    if(this.mode + 1 === this.modes.length){
                        this.mode = 0;
                        this.render();
                    }
                    else{
                        this.setMode(this.mode + 1);
                    }
                }.bind(this));

                if(this['range-picker']){
                    this.on(this.container, 'mouseover', this.hoverSelectRange.bind(this));
                }
            },

            onClickDay: function (node) {
                var
                    day = +node.innerHTML,
                    isFuture = node.classList.contains('future'),
                    isPast = node.classList.contains('past');

                this.current.setDate(day);
                if(isFuture){
                    this.current.setMonth(this.current.getMonth() + 1);
                }
                if(isPast){
                    this.current.setMonth(this.current.getMonth() - 1);
                }

                this.valueDate = copy(this.current);

                this.emitValue();

                if(this['range-picker']){
                    this.clickSelectRange();
                }

                if(isFuture || isPast) {
                    this.render();
                }else{
                    this.selectDay();
                }
            },

            onClickMonth: function (direction) {
                switch (this.mode) {
                    case 1: // year mode
                        this.current.setFullYear(this.current.getFullYear() + (direction * 1));
                        this.setMode(this.mode);
                        break;
                    case 2: // century mode
                        this.current.setFullYear(this.current.getFullYear() + (direction * 12));
                        this.setMode(this.mode);
                        break;
                    default:
                        this.current.setMonth(this.current.getMonth() +(direction * 1));
                        this.render();
                        break;
                }
            },

            onClickYear: function (node) {
                var index = alloy.dates.getMonthIndex(node.innerHTML);
                this.current.setMonth(index);
                this.render();
            },

            onClickDecade: function (node) {
                var year = +node.innerHTML;
                this.current.setFullYear(year);
                this.setMode(this.mode - 1);
            },

            setMode: function (mode) {
                destroy(this.modeNode);
                this.mode = mode || 0;
                switch(this.modes[this.mode]){
                    case 'month':
                        break;
                    case 'year':
                        this.setYearMode();
                        break;
                    case 'decade':
                        this.setDecadeMode();
                        break;
                }
            },

            setYearMode: function () {
                destroy(this.bodyNode);

                var
                    i,
                    node = dom('div', {css:'cal-body year'});

                for(i = 0; i < 12; i++){
                    dom('div', {html: alloy.dates.months.abbr[i], css: 'year'}, node);
                }

                this.monthNode.innerHTML = this.current.getFullYear();
                this.container.appendChild(node);
                this.modeNode = node;
            },

            setDecadeMode: function () {
                var
                    i,
                    node = dom('div', {css: 'cal-body decade'}),
                    year = this.current.getFullYear() - 6;

                for (i = 0; i < 12; i++) {
                    dom('div', {html: year, css: 'decade'}, node);
                    year += 1;
                }
                this.monthNode.innerHTML = (year - 12) + '-' + (year - 1);
                this.container.appendChild(node);
                this.modeNode = node;
            },

            selectDay: function () {
                if(this['range-picker']){
                    return;
                }
                var
                    now = this.querySelector('.ay-selected'),
                    node = this.dayMap[this.current.getDate()];
                if(now){
                    now.classList.remove('ay-selected');
                }
                node.classList.add('ay-selected');

            },

            clearRange: function () {
                this.hoverDate = 0;
                this.setRange(null, null);
            },

            setRange: function (firstRange, secondRange) {
                this.firstRange = firstRange;
                this.secondRange = secondRange;
                this.displayRange();
                this.setRangeEndPoints();
            },

            clickSelectRange: function() {
                var
                    prevFirst = !!this.firstRange,
                    prevSecond = !!this.secondRange,
                    rangeDate = copy(this.current);

                if(this.isOwned){
                    this.fire('select-range', {
                        first: this.firstRange,
                        second: this.secondRange,
                        current: rangeDate
                    });
                    return;
                }
                if(this.secondRange){
                    this.fire('reset-range');
                    this.firstRange = null;
                    this.secondRange = null;
                }
                if(this.firstRange && this.isValidRange(rangeDate)){
                    this.secondRange = rangeDate;
                    this.hoverDate = 0;
                    this.setRange(this.firstRange, this.secondRange);
                }else{
                    this.firstRange = null;
                }
                if(!this.firstRange){
                    this.hoverDate = 0;
                    this.setRange(rangeDate, null);
                }
                this.fire('select-range', {first: this.firstRange, second: this.secondRange, prevFirst: prevFirst, prevSecond: prevSecond});
            },

            hoverSelectRange: function (e) {
                if(this.firstRange && !this.secondRange && e.target.classList.contains('on')) {
                    this.hoverDate = e.target._date;
                    this.displayRange();
                }
            },

            displayRangeToEnd: function () {
                if(this.firstRange) {
                    this.hoverDate = copy(this.current);
                    this.hoverDate.setMonth(this.hoverDate.getMonth() + 1);
                    this.displayRange();
                }
            },

            displayRange: function () {
                var
                    beg = this.firstRange,
                    end = this.secondRange ? this.secondRange.getTime() : this.hoverDate,
                    map = this.dayMap;
                if(!beg || !end){
                    Object.keys(map).forEach(function (key, i) {
                        map[key].classList.remove('ay-range');
                    });
                }else{
                    beg = beg.getTime();
                    Object.keys(map).forEach(function (key, i) {
                        if(inRange(map[key]._date, beg, end)){
                            map[key].classList.add('ay-range');
                        }else{
                            map[key].classList.remove('ay-range');
                        }
                    });
                }
            },

            hasRange: function () {
                return !!this.firstRange && !!this.secondRange;
            },

            isValidRange: function (date) {
                if(!this.firstRange) {
                    return true;
                }
                return date.getTime() > this.firstRange.getTime();
            },

            setRangeEndPoints: function () {
                this.clearEndPoints();
                if(this.firstRange){
                    if(this.firstRange.getMonth() === this.current.getMonth()) {
                        this.dayMap[this.firstRange.getDate()].classList.add('ay-range-first');
                    }
                    if(this.secondRange && this.secondRange.getMonth() === this.current.getMonth()){
                        this.dayMap[this.secondRange.getDate()].classList.add('ay-range-second');
                    }
                }
            },

            clearEndPoints: function () {
                var first = this.querySelector('.ay-range-first'),
                    second = this.querySelector('.ay-range-second');
                if(first){
                    first.classList.remove('ay-range-first');
                }
                if(second){
                    second.classList.remove('ay-range-second');
                }
            },

            render: function(){
                // dateNum increments, starting with the first Sunday
                // showing on the monthly calendar. This is usually the
                // previous month, so dateNum will start as a negative number
                this.setMode(0);
                if (this.bodyNode) {
                    dom.destroy(this.bodyNode);
                }

                this.dayMap = {};

                var
                    node = dom('div', {css: 'cal-body'}),
                    i, tx, nextMonth = 0, isThisMonth, day, css,
                    today = new Date(),
                    isRange = this['range-picker'],
                    d = this.current,
                    incDate = copy(d),
                    daysInPrevMonth = alloy.dates.getDaysInPrevMonth(d),
                    daysInMonth = alloy.dates.getDaysInMonth(d),
                    dateNum = alloy.dates.getFirstSunday(d),
                    dateToday = getSelectedDate(today, d),
                    dateSelected = getSelectedDate(this.valueDate, d);

                this.monthNode.innerHTML = alloy.dates.getMonthName(d) + ' ' + d.getFullYear();

                for (i = 0; i < 7; i++) {
                    dom("div", {innerHTML: alloy.dates.days.abbr[i], css: 'day-of-week'}, node);
                }

                for (i = 0; i < 42; i++) {
                    tx = dateNum + 1 > 0 && dateNum + 1 <= daysInMonth ? dateNum + 1 : "&nbsp;";

                    isThisMonth = false;
                    if (dateNum + 1 > 0 && dateNum + 1 <= daysInMonth) {
                        // current month
                        tx = dateNum + 1;
                        isThisMonth = true;
                        css = 'day on';
                        if(dateToday === tx){
                            css += ' today';
                        }
                        if(dateSelected === tx && !isRange){
                            css += ' ay-selected';
                        }
                    } else if(dateNum < 0) {
                        // previous month
                        tx = daysInPrevMonth + dateNum + 1;
                        css = 'day off past';
                    } else {
                        // next month
                        tx = ++nextMonth;
                        css = 'day off future';
                    }

                    day = dom("div", {innerHTML: tx, css: css}, node);

                    dateNum++;
                    if(isThisMonth) {
                        // Keep a map of all the days
                        // use it for adding and removing selection/hover classes
                        incDate.setDate(tx);
                        day._date = incDate.getTime();
                        this.dayMap[tx] = day;
                    }
                }

                this.container.appendChild(node);
                this.bodyNode = node;
                this.setFooter();
                this.displayRange();
                this.setRangeEndPoints();

                this.emitDisplayEvents();
            },

            setFooter: function () {
                var
                    d = new Date(),
                    str = alloy.dates.days.full[d.getDay()] + ' ' + alloy.dates.months.full[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
                this.footerLink.innerHTML = str;
            }
        });

        var
            today = new Date();

        function getSelectedDate (date, current) {
            if (date.getMonth() === current.getMonth() && date.getFullYear() === current.getFullYear()) {
                return date.getDate();
            }
            return -999; // index must be out of range, and -1 is the last day of the previous month
        }

        function destroy (node) {
            if (node) {
                dom.destroy(node);
            }
        }

        function isThisMonth(date, currentDate){
            return date.getMonth() === currentDate.getMonth() && date.getFullYear() === currentDate.getFullYear();
        }

        function inRange(dateTime, begTime, endTime){
            return dateTime >= begTime && dateTime <= endTime;
        }

        function copy(date){
            return new Date(date.getTime());
        }

    }());
</script>
