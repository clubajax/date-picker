<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>Test DatePicker</title>
	<link rel="stylesheet" href="../node_modules/mocha/mocha.css">
	<link rel="stylesheet" href="./dist/date-picker.css" />
	<script src="../node_modules/mocha/mocha.js"></script>
	<script src="../node_modules/chai/chai.js"></script>
	<script src="./dist/vendor.js"></script>
	<script src="./dist/output.js"></script>
	<script src="./src/assertion.js"></script>

	<script src="//localhost:35750/livereload.js"></script>

	<style>
		html, body {
			height: 100%;
		}

		body {
			padding: 20px;
			font-family: sans-serif;
		}

		section {
			border: 1px solid #ccc;
			padding: 3px;
			margin: 5px;
		}

		.spacing {
			height: 1500px;
		}

		.BR {
			position: absolute;
			right: 20px;
			bottom: 20px;
		}

		.focus-start {
			position: absolute;
			right: 20px;
			top: 120px;
		}

		date-range-input,
		date-range-inputs {
			margin: 10px 0;
		}

		time-input, date-input, date-time-input {
			vertical-align: middle;
			margin: 5px;
		}
	</style>
</head>
<body>
<h1>Test DatePicker</h1>

<div id="mocha"></div>

<div class="xspacing"></div>
<div id="tests">
	<input placeholder="focus start" autofocus class="focus-start" />
</div>
<div class="spacing"></div>

<script>

	window.mocha.setup('tdd');

	suite('DatePicker', function () {
		this.timeout(3000);
		const suite = window.suite,
			test = window.test,
			dom = window.dom,
			on = window.on,
			expect = chai.expect,
			body = dom.byId('tests');

		function ready (node, cb) {
			onDomReady(node, function () {
				setTimeout(cb, 30);
			});
		}

		function key (node, value, pos) {
			pos = pos || node.input.value.length;
			node.input.selectionStart = pos;
			node.input.selectionEnd = pos;
			on.emit(node.input, 'keyup', { key: value });
		}

		function clear (node) {
			node.input.value = '';
		}

		function select (node, beg, end) {
			node.focus();
			end = end === undefined ? beg : end;
			node.input.selectionStart = beg;
			node.input.selectionEnd = end;
		}

		function arrow (node, sel, inc) {
			select(node, sel);
			if (inc > 0) {
				on.emit(node.input, 'keyup', { key: 'ArrowUp' });
			} else {
				on.emit(node.input, 'keyup', { key: 'ArrowDown' });
			}
		}

		function clickDate (node, date) {
			const day = util.toAriaLabel(date);
			const n = dom.query(node, '[aria-label="' + day + '"]');
			if (n) {
				on.emit(n, 'click');
				node.blur();
			} else {
				console.log('could not find:', date);
			}
		}

		function showing (node) {
			return node.picker.classList.contains('show') && dom.style(node.picker, 'display') !== 'none';
		}


		function focus (node) {
			node.focus();
			on.emit(node.input, 'focus');
		}

		suite('tests', function () {

			suite('utils', function () {
				test('it should validate date and time strings', function () {
					const DATE = '12/25/2017';
					const TIME = '02:30 am';
					const DATETIME = DATE + ' ' + TIME;
					expect(util.is(DATE).date()).to.equal(true);
					expect(util.is(TIME).time()).to.equal(true);
					expect(util.is(DATETIME).dateAndTime()).to.equal(true);

					expect(util.is(DATE).time()).to.equal(false);
					expect(util.is(TIME).date()).to.equal(false);
					expect(util.is(DATETIME).type()).to.equal('datetime');
					expect(util.is(DATE).type()).to.equal('date');
					expect(util.is(TIME).type()).to.equal('time');

				});

				test('it should convert a time string to seconds', function () {
					expect(util.timeToSeconds('12:01 am')).to.equal(60);
					expect(util.timeToSeconds('12:01 pm')).to.equal(43260);
					expect(util.timeToSeconds('01:01 am')).to.equal(3660);
					expect(util.timeToSeconds('01:01 pm')).to.equal(46860);
					expect(util.timeToSeconds('11:30 am')).to.equal(41400);
					expect(util.timeToSeconds('11:30 pm')).to.equal(84600);
				});

				test('it should compare times', function () {
					expect(util.is('12:01 am').less('12:02 am')).to.equal(true);
					expect(util.is('12:01 am').less('12:01 pm')).to.equal(true);
					expect(util.is('12:03 am').greater('12:02 am')).to.equal(true);
					expect(util.is('12:01 pm').greater('12:01 am')).to.equal(true);
				});

				test('it should round', function () {
					// round up
					expect(util.round(1, 15)).to.equal(15);
					expect(util.round(9, 15)).to.equal(15);
					expect(util.round(11, 15)).to.equal(15);
					expect(util.round(21, 15)).to.equal(30);
					expect(util.round(4, 10)).to.equal(10);
					expect(util.round(11, 10)).to.equal(20);
					// round down
					expect(util.round(1, 15, true)).to.equal(0);
					expect(util.round(9, 15, true)).to.equal(0);
					expect(util.round(11, 15, true)).to.equal(0);
					expect(util.round(21, 15, true)).to.equal(15);
					expect(util.round(4, 10, true)).to.equal(0);
					expect(util.round(11, 10, true)).to.equal(10);
				});

				test('it should increment minutes', function () {
					// no rounding
					expect(util.incMinutes('00:00 am', 1)).to.equal('00:01 am');
					expect(util.incMinutes('00:30 am', -1)).to.equal('00:29 am');
					expect(util.incMinutes('00:00 am', -1)).to.equal('00:45 am');
					expect(util.incMinutes('00:59 am', 1)).to.equal('00:00 am');

					// even rounding am
					expect(util.incMinutes('00:00 am', 1, 15)).to.equal('00:15 am');
					expect(util.incMinutes('00:30 am', -1, 15)).to.equal('00:15 am');
					expect(util.incMinutes('00:45 am', 1, 15)).to.equal('00:00 am');
					expect(util.incMinutes('00:00 am', -1, 15)).to.equal('00:45 am');

					// odd rounding am
					expect(util.incMinutes('00:05 am', 1, 15)).to.equal('00:15 am');
					expect(util.incMinutes('00:14 am', 1, 15)).to.equal('00:15 am');
					expect(util.incMinutes('00:16 am', 1, 15)).to.equal('00:30 am');
					expect(util.incMinutes('00:29 am', 1, 15)).to.equal('00:30 am');
					expect(util.incMinutes('00:47 am', 1, 15)).to.equal('00:00 am');

				});
			});

			suite('input keys', function () {


				test('it should increment and decrement values - date', function (done) {
					const value = '12/25/2017 2:00 pm';
					const dateInput = dom('date-input', { value: value }, body);
					onDomReady(dateInput, function () {
						expect(dateInput.value).to.equal('12/25/2017');
						arrow(dateInput, 0, 1);
						arrow(dateInput, 4, 1);
						arrow(dateInput, 8, -1);
						expect(dateInput.value).to.equal('01/26/2016');
						done();
					});
				});

				test('it should increment and decrement values - time', function (done) {
					const value = '12/25/2017 2:00 pm';
					const timeInput = dom('time-input', { value: value }, body);
					onDomReady(timeInput, function () {
						expect(timeInput.value).to.equal('02:00 pm');
						arrow(timeInput, 0, 1);
						arrow(timeInput, 5, 1);
						arrow(timeInput, 5, 1);
						arrow(timeInput, 7, 1);
						expect(timeInput.value).to.equal('03:30 am');
						done();
					});
				});

				test('it should increment and decrement values - date-time', function (done) {
					const value = '12/25/2017 2:00 pm';
					const dateTimeInput = dom('date-time-input', { value: value }, body);
					onDomReady(dateTimeInput, function () {

						// dateTime - time
						expect(dateTimeInput.value).to.equal('12/25/2017 02:00 pm');
						arrow(dateTimeInput, 11, 1);
						arrow(dateTimeInput, 14, 1);
						arrow(dateTimeInput, 18, 1);
						expect(dateTimeInput.value).to.equal('12/25/2017 03:15 am');

						// dateTime - date
						arrow(dateTimeInput, 0, -1);
						arrow(dateTimeInput, 4, -1);
						arrow(dateTimeInput, 8, 1);
						expect(dateTimeInput.value).to.equal('11/24/2018 03:15 am');

						done();
					});
				});
			});

			suite('date input', function () {

				test('it should handle arrow keys', function (done) {
					const node = dom('date-input', {
						label: 'Date',
						value: '12/25/2017',
						min: '12/24/2017'
					}, body);

					ready(node, function () {

						expect(node.value).to.equal('12/25/2017');

						arrow(node, 1, 1);
						expect(node.value).to.equal('12/25/2017'); // validation error
						expect(node.valid).to.equal(false);

						arrow(node, 1, -1);
						arrow(node, 4, 1);
						expect(node.value).to.equal('12/26/2017');

						arrow(node, 8, 1);
						expect(node.value).to.equal('12/26/2018');

						done();
					});

				});

				test('it should handle input starting blank', function (done) {
					const node = dom('date-input', {
						label: 'Date'
					}, body);
					ready(node, function () {
						key(node, 1, 0);
						key(node, 2);
						key(node, 2);
						key(node, 5);
						key(node, 2);
						key(node, 0);
						key(node, 1);
						key(node, 7);
						expect(node.valid).to.equal(true);
						done();
					})
				});

				test('it should handle min and max', function (done) {
					const node = dom('date-input', {
						label: 'Date',
						value: '12/25/2017',
						min: '12/24/2017',
						max: '12/26/2017'
					}, body);

					ready(node, function () {
						focus(node);
						clickDate(node, '12/24/2017');
						expect(node.value).to.equal('12/24/2017');

						focus(node);
						clickDate(node, '12/26/2017');
						expect(node.value).to.equal('12/26/2017');

						focus(node);
						clickDate(node, '12/27/2017');
						expect(node.value).to.equal('12/26/2017');

						focus(node);
						clickDate(node, '12/23/2017');
						expect(node.value).to.equal('12/26/2017');
						done();
					});

				});

				test.skip('it should submit in a form (MANUAL)', function (done) {

					// click submit, view result in URL

					const form = dom('form', { method: 'GET' }, body);
					dom('input', { type: 'text', value: 'Mike', name: 'name' }, form);
					const node = dom('date-input', { name: 'date', label: 'Date of Event' }, form);
					const btn = dom('button', { html: 'Submit' }, form);
					on.once(form, 'submit', function (e) {
						console.log('SUBMIT', e);
						// e.preventDefault();
						// return false;
					});
					ready(node, function () {
						btn.focus();
						on.emit(btn, 'click');
						expect(dom.isNode(node)).to.equal(true);
						done();
					});

				});

				test.skip('it should select dates and not lose focus (NOT WORKING)', function (done) {

					// problems with focus
					const node = dom('date-input', {
						label: 'Date',
						value: '12/25/2017'
					}, body);
					ready(node, function () {
						// const time = 1000;
						// focus(node);
						// clickDate(node, '12/01/2017');
						// setTimeout(function () {
						// 	clickDate(node, '12/03/2017');
						// 	setTimeout(function () {
						// 		clickDate(node, '12/05/2017');
						// 		setTimeout(function () {
						// 			clickDate(node, '12/07/2017');
						// 		}, time);
						// 	}, time);
						// }, time);
						done();
					})
				});
			});

			suite('time input', function () {

				test('it should handle valid and invalid from blank', function (done) {
					const node = dom('time-input', { label: 'Time', step: 15 }, body);
					ready(node, function () {
						let emitted;
						const events = [];
						node.on('change', function (e) {
							// console.log('change', e.value);
							events.push(1);
							emitted = events.join(',')
						});
						node.focus();
						key(node, 1, 0);
						node.blur();
						expect(node.valid).to.equal(false);
						node.focus();
						key(node, 2, 1);
						key(node, 3, 2);
						key(node, 4, 3);
						node.blur();
						expect(node.valid).to.equal(true);
						expect(emitted).to.equal('1');
						expect(node.value).to.equal('12:34 pm');
						done();
					});
				});

				test('it should handle valid and invalid from value', function (done) {
					const node = dom('time-input', { label: 'Time', value: '12:34am', step: 15, required: true }, body);
					ready(node, function () {
						let emitted = '';
						const events = [];
						node.on('change', function (e) {
							events.push(1);
							emitted = events.join(',')
						});
						expect(node.valid).to.equal(true);
						expect(emitted).to.equal('');
						expect(node.value).to.equal('12:34 am');
						node.focus();

						// test required
						clear(node);
						node.blur();
						expect(node.valid).to.equal(false);
						done();
					});
				});

				test('it should handle arrow keys', function (done) {
					const node = dom('time-input', { label: 'Time', value: '12:34am', step: 15, required: true }, body);
					ready(node, function () {

						expect(node.value).to.equal('12:34 am');

						arrow(node, 2, 1);
						expect(node.value).to.equal('01:34 am');

						arrow(node, 4, 1);
						expect(node.value).to.equal('01:45 am');

						arrow(node, 6, 1);
						expect(node.value).to.equal('01:45 pm');

						done();
					});
				});

				test('it should handle min and max', function (done) {
					const time = '02:00 am';
					const node = dom('time-input', { label: 'Time', value: time, step: 15, min: '01:30 am', max: '02:30 am' }, body);
					ready(node, function () {
						let err;
						node.on('validation', function (e) {
							//console.log('val:::', e.detail.message);
						});
						expect(node.valid).to.equal(true);
						node.value = '01:00 am';
						expect(node.valid).to.equal(false);

						node.value = '02:00 am';
						expect(node.valid).to.equal(true);

						node.value = '03:00 am';
						expect(node.valid).to.equal(false);

						node.value = '02:00 am';
						expect(node.valid).to.equal(true);

						done();
					});
				});
			});

			suite('date time input', function () {
				test.only('it should persist open with no value', function (done) {
					const node = dom('date-time-input', {
						label: 'Date and Time',
						//value: '03/27/2018 10:00 am',
						min: 'now',
						static: true
					}, body);
					ready(node, function () {

						node.on('validation', function (e) {
							console.log('val:::', e.detail.message);
						});

						expect(showing(node)).to.equal(true);

						// for some reason, onClick is occasionally async
						setTimeout(function () {

							done();
						}, 1);
					});
				});

				test('it should persist open (and staty open)', function (done) {
					const node = dom('date-time-input', {
						label: 'Date and Time',
						value: '03/27/2018 10:00 am',
						static: true
					}, body);
					ready(node, function () {

						expect(showing(node)).to.equal(true);
						clickDate(node, '03/30/2018');

						// for some reason, onClick is occasionally async
						setTimeout(function () {
							expect(showing(node)).to.equal(true);
							expect(node.value).to.equal('03/30/2018 10:00 am');

							arrow(node, 3, -1);
							on.emit(node.input, 'keyup', { key: 'Enter' });
							expect(node.value).to.equal('03/29/2018 10:00 am');
							expect(showing(node)).to.equal(true);

							arrow(node, 3, -1);
							on.emit(node.input, 'keyup', { key: 'Enter' });
							expect(node.value).to.equal('03/28/2018 10:00 am');
							expect(showing(node)).to.equal(true);

							done();
						}, 1);
					});
				});

				test('it should add a time to the picker and handle keys, min/max', function (done) {
					const dateStr = '12/12/2017 02:20 am';
					const max = '12/26/2017 12:00 am';
					const node = dom('date-time-input', { label: 'Enter Date and Time', value: dateStr, min: dateStr, max: max }, body);
					ready(node, function () {
						let err;
						node.on('validation', function (e) {
							//console.log('val:::', e.detail.message);
						});

						expect(node.value).to.equal(dateStr);

						// check time arrow keys
						arrow(node, 12, 1);
						expect(node.value).to.equal('12/12/2017 03:20 am');

						arrow(node, 14, 1);
						expect(node.value).to.equal('12/12/2017 03:30 am');

						arrow(node, 17, 1);
						expect(node.value).to.equal('12/12/2017 03:30 pm');

						arrow(node, 12, -1);
						arrow(node, 12, -1);
						arrow(node, 14, -1);
						on.emit(node.input, 'keyup', { key: 'Enter' });
						expect(node.value).to.equal('12/12/2017 01:15 pm');

						done();
					});
				});

				test('it should handle complex focus', function (done) {
					const dateStr = '12/12/2017 02:20 am';
					const min = '12/08/2017 02:20 am';
					const node = dom('date-time-input', { label: 'Enter Date and Time', value: dateStr, min: min }, body);
					dom('input', { class: 'BR' }, body);
					ready(node, function () {

						done();
					});
				});
			});

			suite('date picker', function () {

				test('it should add a time to the picker', function (done) {
					const node = dom('date-picker', { time: true, value: '12/12/2017 02:20 am' }, body);
					ready(node, function () {
						let emitted;
						const events = [];
						node.on('change', function (e) {
							// console.log('change', e);
							events.push(1);
							emitted = events.join(',');
						});

						node.timeInput.focus();
						clear(node.timeInput);
						node.timeInput.blur();
						done();
					});
				});

				test('it should allow `now` as a min', function (done) {
					const date = new Date();
					const dateStr = dates.format(date, 'MM/dd/yyyy');
					const node = dom('date-picker', { min: 'now', value: dateStr }, body);
					ready(node, function () {
						const todayLabel = util.toAriaLabel(date);
						const todayNode = dom.query(node, `[aria-label="${todayLabel}"]`);
						expect(todayNode.classList.contains('disabled')).to.equal(false);

						date.setDate(date.getDate() - 1);
						const yesterdayLabel = util.toAriaLabel(date);
						const yesterdayNode = dom.query(node, `[aria-label="${yesterdayLabel}"]`);
						expect(yesterdayNode.classList.contains('disabled')).to.equal(true);
						done();
					});
				});

				test('it should allow `now` as a max', function (done) {
					const date = new Date();
					const dateStr = dates.format(date, 'MM/dd/yyyy');
					const node = dom('date-picker', { max: 'now', value: dateStr }, body);
					ready(node, function () {
						const todayLabel = util.toAriaLabel(date);
						const todayNode = dom.query(node, `[aria-label="${todayLabel}"]`);
						expect(todayNode.classList.contains('disabled')).to.equal(false);

						date.setDate(date.getDate() + 1);
						const tomorrowLabel = util.toAriaLabel(date);
						const tomorrowNode = dom.query(node, `[aria-label="${tomorrowLabel}"]`);
						expect(tomorrowNode.classList.contains('disabled')).to.equal(true);
						done();
					});
				});

				test('it should not allow selection before min or after max', function () {
					const node = dom('date-picker', { min: '07/05/2017', max: '07/19/2017', value: '07/01/2017' }, body);
					expect(dom.isNode(node)).to.equal(true);
				});

				test('it should handle min and max with time', function (done) {
					const value = '12/12/2017 04:30 am';
					const min = '12/12/2017 05:30 am';
					const max = '12/13/2017 07:30 am';
					const LESS = 'Value is less than the minimum, ' + min;
					const MAX = 'Value is greater than the maximum, ' + max;
					const node = dom('date-picker', { time: true, value: value, min: min, max: max }, body);
					ready(node, function () {
						let error = node.timeInput.validationError;
						node.on('validation', function (e) {
							//console.log(' --- validation', e.detail.message);
							error = e.detail.message;
						});
						node.timeInput.validate();

						expect(error).to.equal(LESS);
						node.value = max;
						expect(error).to.equal(null);
						node.timeInput.value = '08:00 am';
						expect(error).to.equal(MAX);
						node.timeInput.value = '08:30 am';
						expect(error).to.equal(MAX);
						done();
					});
				});

				test('it should open to the top left', function () {
					const node = dom('date-input', { class: 'BR' }, body);
					expect(dom.isNode(node)).to.equal(true);
				});
			});

			suite('date range inputs', function () {
				test('it should load a date range input', function (done) {
					const node = dom('date-range-input', { label: 'El Date Picker', value: '01/10/2017 - 02/14/2017' }, body);
					expect(dom.isNode(node)).to.equal(true);
					ready(node, function () {
						done();
					});
				});

				test('it should load date range inputs', function (done) {
					const node = dom('date-range-inputs', { 'left-label': 'Start Date', 'right-label': 'End Date', value: '01/10/2017 - 02/14/2017' }, body);
					expect(dom.isNode(node)).to.equal(true);

					ready(node, function () {
						expect(node.value).to.equal('01/10/2017 - 02/14/2017');

						expect(node.leftInput.value).to.equal('01/10/2017');
						expect(node.rightInput.value).to.equal('02/14/2017');

						node.value = '02/10/2017 - 03/17/2017';
						expect(node.leftInput.value).to.equal('02/10/2017');
						expect(node.rightInput.value).to.equal('03/17/2017');
						done();
					});
				});

				test('it should load date range inputs with no value', function (done) {
					const node = dom('date-range-inputs', { 'left-label': 'Start Date', 'right-label': 'End Date', required: true, placeholder: 'Date here' }, body);
					expect(dom.isNode(node)).to.equal(true);

					node.on('change', function (e) {
						// console.log('change.value', node.value);
						// console.log('change.target', e.target);
					});

					ready(node, function () {
						expect(node.value).to.equal(null);

						node.value = '02/10/2017 - 03/17/2017';
						expect(node.value).to.equal('02/10/2017 - 03/17/2017');
						done();
					});
				});

			});

			suite('date range', function () {

				test('it should load a range calendar', function () {
					const node = dom('date-picker', { 'range-picker': true }, body);
					expect(dom.isNode(node)).to.equal(true);
				});

				test('it should load a date range picker', function () {
					const node = dom('date-range-picker', {}, body);
					expect(dom.isNode(node)).to.equal(true);
				});

				test('it should open the other picker if range is (auto-set) the same - MANUAL TEST', function (done) {
					const node = dom('date-range-inputs', { 'left-label': 'Start Date', 'right-label': 'End Date', value: '02/10/2017 - 02/14/2017' }, body);
					const b1 = dom('button', { html: 'clear' }, body);
					const b2 = dom('button', { html: 'value.set' }, body);
					const b3 = dom('button', { html: 'setValue' }, body);
					expect(dom.isNode(node)).to.equal(true);

					on(b1, 'click', function () {
						node.clear();
					});
					on(b2, 'click', function () {
						node.value = '02/10/2017 - 02/14/2017';
					});
					on(b3, 'click', function () {
						node.setValue('02/10/2017 - 02/14/2017', true);
					});

					node.on('change', function (e) {
						// console.log('change.value', node.value);
						// console.log('change.target', e.target);
					});

					onDomReady(node, function () {

						//node.leftInput.value = '02/15/2017';
						//node.value = '02/10/2017 - 03/17/2017';
						//expect(node.value).to.equal('02/10/2017 - 03/17/2017');
						done();
					});
				});

				test('it should open the other picker if range is (auto-set) the same (no initial value) - MANUAL TEST', function (done) {
					const node = dom('date-range-inputs', { 'left-label': 'Start Date', 'right-label': 'End Date' }, body);

					expect(dom.isNode(node)).to.equal(true);
					node.on('change', function (e) {
						console.log('\nEMIT');
						console.log('change.value', node.value);
						console.log('change.target', e.target);
					});

					onDomReady(node, function () {

						//node.leftInput.value = '02/15/2017';
						//node.value = '02/10/2017 - 03/17/2017';
						//expect(node.value).to.equal('02/10/2017 - 03/17/2017');
						done();
					});
				});

			});
		});
	});


	window.mocha.run();

</script>
</body>
</html>