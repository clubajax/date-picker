<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>Test DatePicker</title>
	<link rel="stylesheet" href="../node_modules/mocha/mocha.css">
	<link rel="stylesheet" href="./dist/date-picker.css" />
	<script src="../node_modules/mocha/mocha.js"></script>
	<script src="../node_modules/chai/chai.js"></script>
	<script src="./dist/vendor.js"></script>
	<script src="./dist/output.js"></script>

	<script src="//localhost:35750/livereload.js"></script>

	<style>
		html, body {
			height: 100%;
		}

		body {
			padding: 20px;
			font-family: sans-serif;
		}

		section {
			border: 1px solid #ccc;
			padding: 3px;
			margin: 5px;
		}

		.spacing {
			height: 1500px;
		}

		.BR {
			position: absolute;
			right: 20px;
			bottom: 20px;
		}

		date-range-input,
		date-range-inputs {
			margin: 10px 0;
		}

		time-input, date-input, date-time-input {
			vertical-align: middle;
			margin: 5px;
		}
	</style>
</head>
<body>
<h1>Test DatePicker</h1>

<div id="mocha"></div>

<div class="xspacing"></div>
<div id="tests"></div>
<div class="spacing"></div>

<script>
	window.mocha.setup('tdd');

	suite('DatePicker', function () {
		this.timeout(3000);
		const suite = window.suite,
			test = window.test,
			dom = window.dom,
			on = window.on,
			expect = chai.expect,
			body = dom.byId('tests');

		function ready (node, cb) {
			onDomReady(node, function () {
				setTimeout(cb, 30);
			});
		}

		function key (node, value) {
			node.input.value += value;
			on.emit(node.input, 'keyup', { key: value });
		}

		function clear (node) {
			node.input.value = '';
		}

		function setSelection (node, beg, end) {
			end = end === undefined ? beg : end;
			node.selectionStart = beg;
			node.selectionEnd = end + 1;
		}

		function arrow (node, selection, inc) {
			const dir = inc < 0 ? -1 : 1;
			inc = Math.abs(inc);
			setSelection(node, selection);

		}

		suite('utils', function () {
			test('it should round', function () {
				// round up
				expect(util.round(1, 15)).to.equal(15);
				expect(util.round(9, 15)).to.equal(15);
				expect(util.round(11, 15)).to.equal(15);
				expect(util.round(21, 15)).to.equal(30);
				expect(util.round(4, 10)).to.equal(10);
				expect(util.round(11, 10)).to.equal(20);
				// round down
				expect(util.round(1, 15, true)).to.equal(0);
				expect(util.round(9, 15, true)).to.equal(0);
				expect(util.round(11, 15, true)).to.equal(0);
				expect(util.round(21, 15, true)).to.equal(15);
				expect(util.round(4, 10, true)).to.equal(0);
				expect(util.round(11, 10, true)).to.equal(10);
			});

			test('it should increment minutes', function () {
				// no rounding
				expect(util.incMinutes('00:00', 1)).to.equal('00:01');
				expect(util.incMinutes('00:30', -1)).to.equal('00:29');
				expect(util.incMinutes('00:00', -1)).to.equal('00:45');
				expect(util.incMinutes('00:59', 1)).to.equal('00:00');

				// even rounding
				expect(util.incMinutes('00:00', 1, 15)).to.equal('00:15');
				expect(util.incMinutes('00:30', -1, 15)).to.equal('00:15');
				expect(util.incMinutes('00:45', 1, 15)).to.equal('00:00');
				expect(util.incMinutes('00:00', -1, 15)).to.equal('00:45');

				// odd rounding
				expect(util.incMinutes('00:05', 1, 15)).to.equal('00:15');
				expect(util.incMinutes('00:14', 1, 15)).to.equal('00:15');
				expect(util.incMinutes('00:16', 1, 15)).to.equal('00:30');
				expect(util.incMinutes('00:29', 1, 15)).to.equal('00:30');
				expect(util.incMinutes('00:47', 1, 15)).to.equal('00:00');

			});
		});

		suite('date input', function () {
			test('it should submit in a form', function (done) {
				const form = dom('form', {}, body);
				dom('input', { type: 'text', value: 'Mike', name: 'name' }, form);
				const node = dom('date-input', { name: 'date', label: 'Date of Event' }, form);
				const btn = dom('button', { html: 'Submit' }, form);
				on.once(form, 'submit', function (e) {
					console.log('SUBMIT', e.target.value);
					// e.preventDefault();
					// return false;
				});
				ready(node, function () {
					btn.focus();
					on.emit(btn, 'click');
					expect(dom.isNode(node)).to.equal(true);
					done();
				});

			});

			test.only('it should load custom input of type `date`', function () {
				const node = dom('date-input', { type: 'date', label: 'Date', value: '12/12/2017' }, body);
				expect(dom.isNode(node)).to.equal(true);
				node.on('change', function (e) {
					console.log('change', e.value);
				});
			});
		});
		suite('time input', function () {

			// TODO: handle min/max

			test('it should handle valid and invalid from blank', function (done) {
				const node = dom('time-input', { label: 'Time', step: 15 }, body);
				ready(node, function () {
					let emitted;
					const events = [];
					node.on('change', function (e) {
						console.log('change', e.value);
						events.push(1);
						emitted = events.join(',')
					});
					node.focus();
					key(node, 1);
					key(node, 2);
					key(node, 3);
					node.blur();
					expect(node.valid).to.equal(false);
					// node.focus();
					key(node, 4);
					node.blur();
					expect(node.valid).to.equal(true);
					expect(emitted).to.equal('1');
					expect(node.value).to.equal('12:34 pm');
					done();
				});
			});

			test('it should handle valid and invalid from value', function (done) {
				const node = dom('time-input', { label: 'Time', value: '12:34am', step: 15, required: true }, body);
				ready(node, function () {
					let emitted = '';
					const events = [];
					node.on('change', function (e) {
						console.log('change', e.value);
						events.push(1);
						emitted = events.join(',')
					});
					expect(node.valid).to.equal(true);
					expect(emitted).to.equal('');
					expect(node.value).to.equal('12:34 pm');
					node.focus();
					clear(node);
					node.blur();
					expect(node.valid).to.equal(false);
					done();
				});
			});

			test.skip('it should handle valid and invalid from value', function () {
				const node = dom('time-input', { label: 'Time', value: '12:34am', step: 15, required: true }, body);
				ready(node, function () {
					let emitted = '';
					const events = [];
					node.on('change', function (e) {
						console.log('change', e.value);
						events.push(1);
						emitted = events.join(',')
					});

					node.focus();
					setTimeout(() => {
						arrow(node, 2, 2);
						console.log(' - ', node.selectionStart, node.selectionEnd);
					}, 130)


				});
			});
		});

		suite('date time input', function () {
			test.only('it should add a time to the picker', function (done) {
				const node = dom('date-time-input', { label: 'Enter Date and Time', value: '12/12/2017 02:20 am' }, body);
				ready(node, function () {
					let emitted;
					const events = [];
					node.on('change', function (e) {
						console.log('change', e);
						events.push(1);
						emitted = events.join(',');
					});
					done();
				});
			});
		});

		suite('date picker', function () {

			test('it should add a time to the picker', function (done) {
				const node = dom('date-picker', { time: true, value: '12/12/2017 02:20 am' }, body);
				ready(node, function () {
					let emitted;
					const events = [];
					node.on('change', function (e) {
						console.log('change', e);
						events.push(1);
						emitted = events.join(',');
					});

					node.timeInput.focus();
					clear(node.timeInput);
					node.timeInput.blur();
					done();
				});
			});


			test('it should not allow selection before min of after max', function () {
				const node = dom('date-picker', { min: '07/05/2017', max: '07/19/2017', value: '07/01/2017' }, body);
				expect(dom.isNode(node)).to.equal(true);
			});

			test('it should load a range calendar', function () {
				const node = dom('date-picker', { 'range-picker': true }, body);
				expect(dom.isNode(node)).to.equal(true);
			});

			test('it should load a date range picker', function () {
				const node = dom('date-range-picker', {}, body);
				expect(dom.isNode(node)).to.equal(true);
			});

			test('it should open to the top left', function () {
				const node = dom('date-input', { class: 'BR' }, body);
				expect(dom.isNode(node)).to.equal(true);
			});

			test('it should load a date input', function () {
				const node = dom('date-input', { value: '12/22/2000', label: 'El Date Input' }, body);
				expect(dom.isNode(node)).to.equal(true);
			});

			test('it should load a date range input', function () {
				const node = dom('date-range-input', { label: 'El Date Picker', value: '01/10/2017 - 02/14/2017' }, body);
				expect(dom.isNode(node)).to.equal(true);
			});

			test('it should load date range inputs', function (done) {
				const node = dom('date-range-inputs', { 'left-label': 'Start Date', 'right-label': 'End Date', value: '01/10/2017 - 02/14/2017' }, body);
				expect(dom.isNode(node)).to.equal(true);

				ready(node, function () {
					console.log('node.value', node.value);
					expect(node.value).to.equal('01/10/2017 - 02/14/2017');

					expect(node.leftInput.value).to.equal('01/10/2017');
					expect(node.rightInput.value).to.equal('02/14/2017');

					node.value = '02/10/2017 - 03/17/2017';
					expect(node.leftInput.value).to.equal('02/10/2017');
					expect(node.rightInput.value).to.equal('03/17/2017');
					done();
				});
			});

			test('it should load date range inputs with no value', function (done) {
				const node = dom('date-range-inputs', { 'left-label': 'Start Date', 'right-label': 'End Date', required: true, placeholder: 'Date here' }, body);
				expect(dom.isNode(node)).to.equal(true);

				node.on('change', function (e) {
					console.log('change.value', node.value);
					console.log('change.target', e.target);
				});

				ready(node, function () {
					expect(node.value).to.equal(null);

					node.value = '02/10/2017 - 03/17/2017';
					expect(node.value).to.equal('02/10/2017 - 03/17/2017');
					done();
				});
			});

			test('it should open the other picker if range is (auto-set) the same - MANUAL TEST', function (done) {
				const node = dom('date-range-inputs', { 'left-label': 'Start Date', 'right-label': 'End Date', value: '02/10/2017 - 02/14/2017' }, body);
				const b1 = dom('button', { html: 'clear' }, body);
				const b2 = dom('button', { html: 'value.set' }, body);
				const b3 = dom('button', { html: 'setValue' }, body);
				expect(dom.isNode(node)).to.equal(true);

				on(b1, 'click', function () {
					node.clear();
				});
				on(b2, 'click', function () {
					node.value = '02/10/2017 - 02/14/2017';
				});
				on(b3, 'click', function () {
					node.setValue('02/10/2017 - 02/14/2017', true);
				});

				node.on('change', function (e) {
					console.log('\nEMIT');
					console.log('change.value', node.value);
					console.log('change.target', e.target);
				});

				onDomReady(node, function () {

					//node.leftInput.value = '02/15/2017';
					//node.value = '02/10/2017 - 03/17/2017';
					//expect(node.value).to.equal('02/10/2017 - 03/17/2017');
					done();
				});
			});

			test('it should open the other picker if range is (auto-set) the same (no initial value) - MANUAL TEST', function (done) {
				const node = dom('date-range-inputs', { 'left-label': 'Start Date', 'right-label': 'End Date' }, body);

				expect(dom.isNode(node)).to.equal(true);
				node.on('change', function (e) {
					console.log('\nEMIT');
					console.log('change.value', node.value);
					console.log('change.target', e.target);
				});

				onDomReady(node, function () {

					//node.leftInput.value = '02/15/2017';
					//node.value = '02/10/2017 - 03/17/2017';
					//expect(node.value).to.equal('02/10/2017 - 03/17/2017');
					done();
				});
			});

		});
	});

	window.mocha.run();

</script>
</body>
</html>